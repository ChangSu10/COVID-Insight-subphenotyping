# -*- coding: utf-8 -*-
"""
Created on Mon Sep 21 22:02:15 2020

@author: chs4001

Initial filtering of lab data.


"""

import pandas as pd
import datetime
import json



TARGET_LABs = {
        'venous_lactate': ['2519-7', '19240-1'],  # mmol/L
        'creatinine': ['2160-0', '21232-4', '38483-4'],  # mg/dL
        'white_blood_cell_count': ['33256-9', '12227-5', '6690-2', '6743-9', '806-0', '813-6', '26464-8', '26465-5'],  # x10^3 cells per uL
        'lymphocyte_count': ['731-0', '732-8', '26474-7', '30364-4'],  # x10^3 cells per uL
        'platelet_count': ['777-3', '778-1', '26515-7'],  # x10^3 cells per uL
        'bilirubin': ['33898-8', '1971-1', '14152-3', '1968-7', '15152-2', '58941-6',
                      '1974-5', '1975-2', '1978-6'],  # mg/dL
        'aspartate_aminotransferase': ['1920-8', '30239-8'],  # U/L
        'alanine_aminotransferase': ['1742-6', '1743-4'],  # U/L
        'creatine_kinase': ['2157-6'],  # U/L  
        'prothrombin_time': ['5964-2', '5902-2', '5901-4', '33356-7', '5959-2', '53748-0'],  # s
        'interleukin-6': ['26881-3'],  # pg/mL
        'high-sensitive_CRP': ['71426-1', '30522-7'],  # mg/L
        'Ferritin': ['2276-4'],  # ng/mL
        'D-dimer': ['48065-7'],  # ug/mL
        'high-sensitive_cardiac_troponin_T': ['67151-1'],  # ng/mL
        'procalcitonin': ['33959-8'],  # ng/mL
        'albumin': ['1751-7'],  # g/dL
        'red_blood_cell_distribution_width': ['30384-2', '30385-9', '788-0'],
        'neutrophil_count': ['26499-4', '751-8', '753-4'],  # x10^3 cells per uL
        
        'proteinuria': ['14959-1', '14957-5', '2890-2', '50561-0'],
        'C-reactive_protein': ['71426-1', '1988-5', '30522-7'],
        'cardiac_troponin_I': ['42757-5', '10839-9'], 
        'cardiac_troponin_T': ['6598-7', '67151-1'],
        
        
        # additional labs, added in Oct 6        
        'LDH': ['11053-6', '14403-0', '14803-1', '14804-9', '14805-6', '2527-0', '2528-8',
                 '2529-6', '2530-4', '2531-2', '2532-0', '2533-8', '2534-6', '32324-6',
                 '33367-4', '47678-8', '47863-6', '56759-4', '57664-5', '5921-2', '60017-1',
                 '60018-9', '60019-7', '60020-5', '60021-3', '60022-1', '60023-9', '60024-7', 
                 '68387-0', '68452-2', '68453-0', '81430-1'], 

        'Bicarbonate': ['16551-4', '19223-7', '2026-3', '2027-1', '2028-9', '20565-8', 
                        '34520-7', '34728-6', '39465-0', '39466-8', '41647-9', '48391-7', 
                        '51781-3', '57920-1', '57921-9', '57922-7', '57923-5', '77143-6'], 
                        
        'BUN': ['12961-9', '12962-7', '12963-5', '14937-7', '3094-0', '35234-4', '59570-2', '6299-2'],
        
        'CHLORIDE': ['2069-3', '2073-5', '2075-0', '41649-5', '41650-3', '51590-8', '77138-6'], 
        
        'ESR': ['18184-2', '30341-2', '43402-7', '4537-7', '4538-5', '4539-3', '82477-1'],
        
        'GLUCOSE': ['14743-9', '14749-6', '15074-8', '2339-0', '2340-8', '2341-6', 
                          '2345-7', '32016-8', '35211-2', '39480-9', '39481-7', '41651-1', '41652-9',
                          '41653-7', '47995-6', '51596-5', '6777-7', '72516-8', '74774-1', '77135-2'], 
                          
        'HEMOGLOBIN': ['14775-1', '20509-6', '30313-1', '30350-3', '30351-1', '30352-9',
                             '30353-7', '30354-5', '33025-8', '33026-6', '35183-3', '40719-7',
                             '42243-6', '55782-7', '59260-0', '718-7', '75928-2', '76768-1', '76769-9'],
                             
        'SODIUM': ['12907-2', '2947-0', '2951-2', '32717-1', '39791-9', '39792-7', '41657-8',
                   '42570-2', '44783-9', '77139-4', '82812-9'], 
                   
        'Neutrophils.band': ['34524-9', '763-3', '26507-4', '30229-9', '66138-9', # Neutrophils.band form
                             '764-1', '26508-2', '35332-6', # Neutrophils.band form/100 leukocytes
                             '71670-4' # Neutrophils.band form/leukocytes
                             ],
                             
        # vital sings
        'Heart_rate': ['8873-2', '41924-2', '8883-1', '8867-4'],
        'Body_temperature': ['8310-5', '9279-1'],
        'Oxygen_saturation': ['51733-4', '51732-6', '51731-8', '2708-6', '28642-7', '28643-5', '71853-6'
                              '2709-4', '19224-5', '2711-0'
                              ]
        
        # has data
#        'LDH': ['14804-9', '14805-6', '2529-6', '2532-0', '60017-1'], 
#        'Bicarbonate': ['16551-4', '19223-7', '2026-3', '2027-1', '2028-9', '20565-8'], 
#        'BUN': ['3094-0', '6299-2'], 
#        'CHLORIDE': ['2069-3', '2075-0', '41649-5', '41650-3', '51590-8'], 
#        'ESR': ['30341-2', '4537-7'], 
#        'GLUCOSE': ['2339-0', '2345-7', '32016-8', '41651-1', '41652-9', '41653-7'], 
#        'HEMOGLOBIN': ['20509-6', '30313-1', '30350-3', '30351-1', '30352-9', '718-7'], 
#        'SODIUM': ['2947-0', '2951-2', '32717-1', '39791-9', '39792-7'], 
#        'Neutrophils.band': ['763-3', '26507-4', '764-1', '26508-2', '35332-6'], 
#        
#        'Oxygen_saturation': ['51733-4', '51732-6', '51731-8', '2708-6', '28642-7', '28643-5']
                        
        }

TARGET_LABs = {
        'Heart_rate': ['76476-1', '76282-3', '8876-5', '8871-6', '41922-6', '8881-5', '89692-8',
                               '8877-3', '8872-4', '41923-4', '8882-3', '8874-0', '8869-0', '41920-0',
                               '8879-9', '8878-1', '8873-2', '41924-2', '8883-1', '8875-7', '8870-8', 
                               '41921-8', '8880-7', '11328-2', '55422-0', '8889-8', '8890-6', '8891-4', 
                               '60978-4', '8893-0', '8892-2', '8867-4', '55426-1', '55425-3', '89278-6', 
                               '89271-1', '89282-8', '40442-6', '67129-7', '40443-4', '66440-9', '55283-6',
                               '57068-9', '11948-7', '76477-9', '19946-3', '19947-1', '69000-8', '69001-6', 
                               '68999-2', '89273-7', '89291-9'], 
        'Body_temperature': ['8323-8', '8313-9', '8318-8', '8324-6', '8314-7', '8319-6', '8321-2', '8311-3',
                             '8316-2', '8325-3', '8315-4', '8320-4', '8322-0', '8312-1', '8317-0', '11289-6', 
                             '8310-5', '91371-5', '8329-5', '8309-7', '8330-3', '61008-9', '75539-7', '8334-5', 
                             '50400-1', '60835-6', '8328-7', '60834-9', '75987-8', '76011-6', '60836-4', '60830-7',
                             '8331-1', '61009-7', '60838-0', '76010-8', '8332-9', '60955-2', '60833-1', '8333-7',
                             '76278-1', '20091-5', '60839-8', '81265-1'], 
        'Respiratory_rate ': ['9287-4', '9282-5', '9292-4', '9288-2', '9283-3', '9293-2', '9285-8', '9280-9', 
                              '9290-8', '9289-0', '9284-1', '9294-0', '9286-6', '9281-7', '9291-6', '11291-2', 
                              '9279-1', '76170-0', '76171-8', '76172-6', '76270-8', '76173-4', '76174-2', '19842-4',
                              '19841-6', '89279-4', '9295-7', '9296-5', '9297-3', '40441-8', '9298-1', '9299-9', 
                              '9300-5', '9301-3', '9302-1', '9303-9', '89274-5', '89292-7', '9275-9', '76528-9', 
                              '19839-0', '19840-8', '76526-3'], 
        'Oxygen_saturation': ['2713-6', '51733-4', '51732-6', '74105-8', '51731-8', '71844-5', '71843-7', 
                              '71842-9', '71841-1', '59405-1', '59406-9', '8839-3', '20564-1', '59418-4', 
                              '59407-7', '2708-6', '59408-5', '2709-4', '68363-1', '28642-7', '28643-5',
                              '19224-5', '2711-0', '8848-4', '8849-2', '8840-1', '8841-9', '8842-7', '8843-5',
                              '8844-3', '8845-0', '8847-6', '8846-8', '8851-8', '8852-6', '8853-4', '8854-2', '8850-0',
                              '8855-9', '71853-6', '71852-8', '71851-0', '71849-4', '71848-6', '71847-8', '71846-0', 
                              '71845-2', '43146-0', '89277-8', '89272-9', '59409-3', '59410-1', '59411-9', '59412-7',
                              '59413-5', '59414-3', '59415-0', '59416-8', '59417-6', '89276-0'],
        'Smoking': ['81229-7', '64234-8']
        }


SCREEN_DATE = datetime.datetime.strptime('2020-03-01', '%Y-%m-%d')
SCREEN_END_DATE = datetime.datetime.strptime('2020-06-12', '%Y-%m-%d')

MONTH_MAP = {
        'JAN':'01', 'FEB':'02', 'MAR':'03', 'APR':'04', 'MAY':'05', 'JUN':'06',
        'JUL':'07', 'AUG':'08', 'SEP':'09', 'OCT':'10', 'NOV':'11', 'DEC':'12'      
        }


MAIN_DIR = "W:\\WorkArea-chs4001"

SITES = [1, 3, 4, 5, 8]
#SITES = [1]


#VERSION = '0922'
#VERSION = '1006'
VERSION = '1007_vital'





# conunting frequncy of each lab code
lab_code_pool = {}
for lab in TARGET_LABs:
    lab_codes = TARGET_LABs[lab]
    for c in lab_codes:
        lab_code_pool[c] = 0


for site in SITES:
    # load cohort
    cohort_df = pd.read_csv(MAIN_DIR + '\\Data\\cohort\\Lab_DX_Site_%s.csv' % site)
    cohort = {}
    for p in cohort_df['ssid'].values.tolist():
        cohort[p] = None
        
    # load lab data
    lab_df = pd.read_csv(MAIN_DIR + '\\Data\\INSIGHT_COVID_Site%s\\CSV\\lab_result_cm.csv' % site,
                               header=0, parse_dates=True)   
    
    # filtering by lab code
    lab_df = lab_df[lab_df['lab_loinc'].isin(lab_code_pool)]
    
    # filtering by ssid
    lab_df = lab_df[lab_df['ssid'].isin(cohort)]
    
    lab_df['SPECIMEN_DATE'] = pd.to_datetime(lab_df['SPECIMEN_DATE'], format='%d%b%Y')
    lab_df = lab_df[lab_df['SPECIMEN_DATE'] >= SCREEN_DATE]
    
    print(len(lab_df))
    
    
    for c in lab_code_pool:
        lab_code_pool[c] += len(lab_df[lab_df['lab_loinc'] == c])

    lab_df.to_csv(MAIN_DIR + '\\Data\\INSIGHT_COVID_Site%s\\target_labs_%s.csv' % (site, VERSION), index=False)
    
    print('Site %s finished...' % site)   
    
with open(MAIN_DIR + '\\Data\\target_lab_code_frequency_%s.json' % VERSION, 'w') as outf:
    json.dump(lab_code_pool, outf, indent=4)











